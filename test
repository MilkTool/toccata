#!/bin/bash

set -e

# $CC -O3 -g -fno-objc-arc -std=c99 -c core.c &&

git checkout toccata.c &&
$CC -O3 -g -fno-objc-arc -o toccata -std=c99 core.c toccata.c -lpthread &&

echo &&
echo "restored" &&
echo &&

time `./toccata toccata.toc > toccata.c` &&
mv toccata.c toccata.tmp &&
awk '/^#$/ { printf "#line %d \"%s\"\n", NR+1, "toccata.c"; next; } { print; }' toccata.tmp > toccata.c &&
$CC -O3 -g -fno-objc-arc -o toccata -std=c99 core.c toccata.c -lpthread &&

echo &&
echo "compiled" &&
echo &&

# run try.toc

# $TOCCATA_DIR/toccata regression-tests/test-regressions.toc > m.tmp &&
# awk '/^#$/ { printf "#line %d \"%s\"\n", NR+1, "m.c"; next; } { print; }' m.tmp > m.c &&
# $CC -g -fno-objc-arc -o m -std=c99 core.c m.c -lpthread &&
# ./m

# failing runtime tests
# test-runtime-check runtime-tests/bad-field-1.toc &&

for file in regression-tests/test*.toc
do
   echo
   echo "testing" $file
   ./test-regression $file
done &&

for file in assertion-tests/*.toc
do
   echo
   # echo "testing" $file
   ./test-assertion $file
done &&

for file in runtime-tests/*.toc
do
   echo
   echo "testing" $file
   ./test-runtime-check $file
done &&

time `./toccata toccata.toc > toccata.c` &&
mv toccata.c toccata.tmp &&
awk '/^#$/ { printf "#line %d \"%s\"\n", NR+1, "toccata.c"; next; } { print; }' toccata.tmp > toccata.c &&
$CC -O3 -g -fno-objc-arc -o toccata -std=c99 core.c toccata.c -lpthread &&

time `./toccata toccata.toc > toccata.c` &&
mv toccata.c toccata.tmp &&
awk '/^#$/ { printf "#line %d \"%s\"\n", NR+1, "toccata.c"; next; } { print; }' toccata.tmp > toccata.c &&
$CC -O3 -g -fno-objc-arc -o toccata -std=c99 core.c toccata.c -lpthread &&

echo "Regressions pass"
